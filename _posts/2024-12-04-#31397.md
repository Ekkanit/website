---
layout: pr
date: 2024-12-04
title: "Track and use all potential peers for orphan resolution"
pr: 31397
authors: [glozow]
components: ["p2p"]
host: glozow
status: upcoming
commit:
---

## Notes

- (Transaction) **orphan resolution** is a process that kicks off when we are missing UTXOs to
  validate an unconfirmed transaction.

  - On master, we [request missing parents by txid](https://github.com/bitcoin/bitcoin/blob/dbc8ba12f3b3548dd6955293c5d650320ca39c5b/src/node/txdownloadman_impl.cpp#L316-L365).

  - BIP 331 also defines a way to [explicitly request a transaction's ancestor package](https://github.com/bitcoin/bips/blob/master/bip-0331.mediawiki#handle-orphans-better).

  - Note that there is a difference between orphan *transactions* and orphan *blocks*.

- Currently, we only attempt to resolve orphans with the peer who provided them. If this doesn't
  work out (e.g. they send a `notfound` or don't respond), we do not try again. In fact, we can't,
because we've already forgotten who else could help.

- The `TxRequestTracker`, introduced in [PR #19988](https://github.com/bitcoin/bitcoin/pull/19988),
  is a data structure that tracks hashes of transactions to download and the candidate peers for
requesting those transactions. It schedules requests to send, helps avoid duplicate in-flight
transaction requests, and encodes prioritization of peers.

- In transaction download, outbound peers are preferred over inbound peers, though the
  `TxRequestTracker` does not have internal knowledge of connection directions; the preference is
expressed by adding a delay to the annouuncement entry. In orphan resolution, there are similar
reasons for preferring outbound over inbound peers.

- When a transaction is rejected from or accepted to mempool, we call `ForgetTxHash` on the
  `TxRequestTracker`, indicating that we have successfully downloaded the transaction. Downloading
it from a different peer will not make the transaction valid, so we do not need to keep it around.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)? What was your review approach?

1. Define orphan resolution, in your own words.

1. Prior to this PR, what are the steps for orphan resolution, starting from when we notice that the
   transaction has missing inputs? Where in the code does this happen?

1. What are the ways we may fail to resolve an orphan with the peer we request its parents from?
   What are some reasons things this may happen, honest or otherwise? (Hint: one honest example is
that the peer disconnects before responding to our request, perhaps because they are going offline)

1. Can you come up with an attack to prevent a node from downloading a 1p1c package by exploiting
   today's orphan resolution behavior? Temporary and/or probabilitistic censorship are ok.

1. What is the PR's solution to this problem?

1. Can you think of any alternatives - does BIP 331 fix any of this?

1. In this PR, which peers do we identify as potential candidates for orphan resolution, and why?

1. What does the node do if a peer announces a transaction that is currently a to-be-resolved orphan?

1. Prior to this PR, what are all the `TxOrphanage` methods that remove an orphan, and where in
   the code are they called? (Hint: you should end up with 5 links to code)

1. Take a look at the
   [logic](https://github.com/bitcoin-core-review-club/bitcoin/commit/c04d1a876cdbcd159c53dde55d57a55675c41f38#diff-3fc44df0a49b8a2fa4cb515b41fae470b794c32c93e632edb18ae14e8fcb159dR462-R481)
for adding a transaction to the orphanage and `m_orphan_resolution_tracker`. Is it possible that
there are candidate peers but `AddTx` is not called - how? Why is that important?

1. This PR edits some of the erasures to potentially keep the transaction in the orphanage and only
   modify the announcers list instead. Which places are these, and why? (Hint: for example,
`EraseForPeer` is called when a peer disconnects)

1. Commit
   [7badc73](https://github.com/bitcoin-core-review-club/bitcoin/commit/7badc7e004e288aef645404b1b09699be8b87d1e)
stores missing parent txids in the `TxOrphanage` entry. Another approach could be to re-calculate
the missing parents prior to sending out requests; the missing parents may change over time as well.
Which approach do you prefer, and why?

1. Should it be possible for a transaction to be in `m_orphanage` but not
   `m_orphan_resolution_tracker`? Why or why not? How might you test this?

1. Why might we prefer to resolve orphan with outbound peers over inbound peers?

1. What are the disadvantages of resolving orphans by requesting parent txids? (Hint: see [BIP 331](https://github.com/bitcoin/bips/blob/master/bip-0331.mediawiki#handle-orphans-better)). Does this PR change that?

1. Commit [3e16a36](https://github.com/bitcoin-core-review-club/bitcoin/commit/3e16a36959f70da59846621f099c1f1df4a210ed)
edits the 1p1c logic to no longer try packages of transactions from different peers. Why is this ok?

<!-- TODO: After a meeting, uncomment and add meeting log between the irc tags
## Meeting Log

### Meeting 1

{% irc %}
-->
<!-- TODO: For additional meetings, add the logs to the same irc block. This ensures line numbers keep increasing, avoiding hyperlink conflicts for identical line numbers across meetings.

### Meeting 2

-->
{% endirc %}
