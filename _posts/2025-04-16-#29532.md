---
layout: pr
date: 2025-04-16
title: "Refactor BnB tests"
pr: 29532
authors: [murchandamus]
components: ["tests"]
host: murchandamus
status: upcoming
commit:
---

_Notes and questions to follow soon!_

## Notes

### Motivation

The author of this PR [noticed](https://github.com/bitcoin/bitcoin/issues/27754)
that many coin selection tests use coin selection parameters that generally do
not appear in production use. The unusual parameters could lead to unexpected
coin selection behavior.

The quirky outcomes would cause confusion when writing or reviewing new tests
because coin selection results could be heavier or lighter than expected,
selection could be unstable when it was expected to be deterministic, waste
scores could diverge from the predicted values, or changeful solutions could
unexpectedly be preferred to changeless solutions.

For example, when the `cost_of_change` parameter was set to 0, any selection
result would be interpreted as resulting in a changeless transaction. I.e.,
when `cost_of_change` was 0 and Single Random Draw picked a 1₿-input for a 0.1₿
selection target, the result would be evaluated as if dropping 0.9₿ to fees
instead of creating a ~0.9₿ change output.

Additionally, most coin selection tests use a feerate of 0 ṩ/vB, which results
in the amount of UTXOs to be equal to their [_effective
value_](https://bitcoin.stackexchange.com/q/103654/5406) (amount - input fee).
This makes it easy to predict the change amount from the input amounts, but
e.g., means that the fees for a heavy or light transaction are the same (namely
0).

The described issues were [partially
fixed](https://github.com/bitcoin/bitcoin/issues/28366) by removing the
double-meaning of `cost_of_change`. This pull requests is the start of an
effort to rewrite the coin selection tests to use non-zero feerates, and create
UTXO per their effective values), so that coin selection may happen at non-zero
feerates and behave as would be expected in production use.

- [ ] How to review and test the changes
- [ ] Advantages and disadvantages of the approach compared to alternative approaches
- [ ] Potential bugs reviewers might want to look out for


## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)? What was your review approach?


<!-- TODO: After a meeting, uncomment and add meeting log between the irc tags
## Meeting Log

### Meeting 1

{% irc %}
-->
<!-- TODO: For additional meetings, add the logs to the same irc block. This ensures line numbers keep increasing, avoiding hyperlink conflicts for identical line numbers across meetings.

### Meeting 2

-->
{% endirc %}
