---
layout: pr
date: 2024-06-05
title: "Don't wipe indexes again when continuing a prior reindex"
pr: 30132
authors: [TheCharlatan]
components: ["utxo db and indexes"]
host: stickies-v
status: upcoming
commit: eeea0818c1a20adc5225b98b185953d386c033e0
---

## Notes

- Recommended reading from earlier review clubs:
  - [#21726: Improve Indices on pruned nodes via prune blockers](/21726) for more background on indexes.
  - [#16981: Improve runtime performance of --reindex](/16981) for more background on the reindexing process.

- Bitcoin Core currently implements five indexes. Two are required: the UTXO set (`CCoinsViewDB`, also often referred to as "coins db") and the block index (`BlockTreeDB`). Three are optional: a transaction index (enabled with `-txindex`), a compact block filter index (enabled with `-blockfilterindex=<type>`), and a coinstats index (enabled with `-coinstatsindex`).

- When running with `-reindex`, all indexes are wiped and rebuilt (generally from the block files on disk). This process can take quite a while, and it can be aborted by the user before it is finished.

- Because the node needs to have an up to date UTXO set and block index, the reindexing state is persisted on disk. When a reindex is started, a flag is [set](https://github.com/bitcoin/bitcoin/blob/457e1846d2bf6ef9d54b9ba1a330ba8bbff13091/src/node/blockstorage.cpp#L58), and it will only be unset when the reindex is finished. This way, when the node starts, it can detect that it should continue reindexing, even if the user didn't provide the flag as a startup option.

- This PR can make node startup more efficient by avoiding the wiping of the optional indexes when it is not necessary.


## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)? What was your review approach?

2. What is the behaviour change introduced by this PR. Can you reproduce it, and if so - how?

3. What are the two ways an index can process new blocks? How does this PR affect that logic?

4. What are the potential risks of not wiping the optional indexes when a reindex is continued? How are these addressed, if at all?

5. What is the difference between `ChainstateLoadOptions::reindex` and `BlockManager::Options::reindex`? Why do we need both?

6. Does [9de8b26](https://github.com/bitcoin-core-review-club/bitcoin/commit/9de8b263dabd6dd2f86f1f0253c6ee3fac7a4407) introduce any behaviour change? What is the relation between `chainman.m_blockman.m_reindexing` and `blockman_opts.reindex`? When are they the same, when are they different?

7. This PR fixes a bug introduced in [b47bd95](https://github.com/bitcoin-core-review-club/bitcoin/commit/b47bd959207e82555f07e028cc2246943d32d4c3). What is the bug, and under which circumstances could it manifest?

8. The [0d04433](https://github.com/bitcoin-core-review-club/bitcoin/commit/0d04433149324616e838a30512bee9a04397855f) commit message states that "Log messages indicating when indexes and chainstate databases are loaded exist in other places.". What are these places?

9. Are there any circumstances under which [9de8b26](https://github.com/bitcoin-core-review-club/bitcoin/commit/9de8b263dabd6dd2f86f1f0253c6ee3fac7a4407) will cause an optional index to be wiped, where prior to this commit it wouldn't be wiped?

<!-- TODO: After a meeting, uncomment and add meeting log between the irc tags
## Meeting Log

### Meeting 1

{% irc %}
-->
<!-- TODO: For additional meetings, add the logs to the same irc block. This ensures line numbers keep increasing, avoiding hyperlink conflicts for identical line numbers across meetings.

### Meeting 2

-->
{% endirc %}
